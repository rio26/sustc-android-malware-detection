import os
m={}
keyword=[]
count=0


#获得一个smali的api
def getApi(file):
	global m
	global count
	if file[-5:]!="smali":
		return
	f=open(file)
	lines=f.readlines()
	f.close()
	for line in lines:
		if line.find("invoke")!=-1:
			# print(line.split(",")[-1])
			s=line.split(",")[-1][:-1]
			if s not in m.keys():
				m[s]=1
			else:
				m[s]+=1
			count+=1

#读取常用的lib，过滤掉外部的包的影响
def readLib():
	global keyword
	for path ,dir,files in os.walk("libraries"):
		for file in files:
			f=open(path+"/"+file)
			lines=f.readlines()
			f.close()
			for line in lines:
				keyword.append(line[:-1])

#输出所有api和它们出现的次数
def writeApis(output_dir):
	global count
	global m
	f=open(output_dir,'w')
	for key,value in sorted(m.items(), key=lambda x: x[1],reverse=True):
		f.write(str(key)+"\n"+str(value/count)+"\n")
	f.close()

#扫描apk,将所有api存到map里
def scanSmali(input_dir):
	for path,dir,files in os.walk(input_dir):
		for file in files:
			getApi(path+"/"+file)

def deletePackageSmali(input_dir):
	for path,dir,files in os.walk(input_dir):
		if path.split("/")[-1]=="smali":
			for p,d,f in os.walk(path):
				#取出package name,判断是否包含在common lib里
					p_split=p.split("/")
					smali_idx=p_split.index('smali')
					p_split=p_split[smali_idx+1:]
					pkg=""
					for i in range(len(p_split)-1):
						pkg=pkg+p_split[i]+"."
					if pkg!="":
						pkg=pkg[:-1]
					if pkg in keyword:
						pkg=pkg.replace(".","/")
						print(path+"/"+pkg)
						os.system("rm -rf "+path+"/"+pkg)
						continue


readLib()
#apk反编译文件的文件夹,必要时可以把benign和malware分开放来分析
deletePackageSmali("origin")
scanSmali("origin")
#输出文件
writeApis("all_apis_benign.txt")

