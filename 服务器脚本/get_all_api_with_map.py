malware_dir=""

import os
malware_apks={}
benign_apks={}
keyword=[]
api_list=[]
two={}

#读取常用的lib，过滤掉外部的包的影响
def readLib():
	global keyword
	for path ,dir,files in os.walk("libraries"):
		for file in files:
			f=open(path+"/"+file)
			lines=f.readlines()
			f.close()
			for line in lines:
				keyword.append(line[:-1])

def deletePackageSmali(input_dir):
	for path,dir,files in os.walk(input_dir):
		if path.split("/")[-1]=="smali":
			for p,d,f in os.walk(path):
				#取出package name,判断是否包含在common lib里
					p_split=p.split("/")
					smali_idx=p_split.index('smali')
					p_split=p_split[smali_idx+1:]
					pkg=""
					for i in range(len(p_split)-1):
						pkg=pkg+p_split[i]+"."
					if pkg!="":
						pkg=pkg[:-1]
					if pkg in keyword:
						pkg=pkg.replace(".","/")
						print(path+"/"+pkg)
						os.system("rm -rf "+path+"/"+pkg)
						continue

#目录结构
#origin/benign/benign
#origin/malware/family
def scanSmali(d,apks):
	for family in os.listdir(d):
		if os.path.isdir(os.path.join(d,family)):
			for apk in os.listdir(os.path.join(d,family)):
				if os.path.isdir(os.path.join(d,family,apk)):
					for p,dd,f in os.walk(os.path.join(d,family,apk)):
						for file in f:
							if len(file)>=5 and file[-5:]=="smali":
								# print(os.path.join(p,file))
								getApi(os.path.join(p,file),apk,apks)


#获得一个smali的api
def getApi(file,apk,apks):
	global api_list
	if apk not in apks.keys():
		apks[apk]={}
	f=open(file)
	lines=f.readlines()
	f.close()
	for line in lines:
		if line.find("invoke")!=-1:
			# print(line.split(",")[-1])
			api=line.split(",")[-1][:-1]
			if api not in api_list:
				api_list.append(api)
			if api not in apks[apk].keys():
				apks[apk][api]=1
			else:
				apks[apk][api]+=1

#two {api:[malware,benign]}
def getTwoData():
	global two
	global benign_apks
	global malware_apks
	global api_list
	for api in api_list:
		malware_count=[]
		benign_count=[]
		for k,apk in malware_apks.items():
			if api in apk.keys():
				malware_count.append(apk[api])
			else:
				malware_count.append(0)
		for k,apk in benign_apks.items():
			if api in apk.keys():
				benign_count.append(apk[api])
			else:
				benign_count.append(0)
		two[api]=[]
		two[api].append(malware_count)
		two[api].append(benign_count)

#第一行api第二行malware第三行benign
#ttest 脚本还没写完
def writeTwo():
	global two
	f=open("two.txt",'w')
	for key,value in two.items():
		first=""
		second=""
		for i in value[0]:
			first+=str(i)
			first+=" "
		for i in value[1]:
			second+=str(i)
			second+=" "
		f.write(str(key)+"\n"+first+"\n"+second+"\n")
	f.close()

def getPass():
	# global two
	# import getTTestResult.py
	# pass_apis=[]
	# for key,value in two.items():
	# 	if(getTTestResult(value[0],value[1])):
	# 		pass_apis.append(key)

	# f=open("pass_apis.txt",'w')
	# for i in pass_apis:
	# 	f.write(i)
	# 	f.write("\n")
	# f.close()
	os.system("python2 getTTestResult.py")





#把common library 读进keyword数组
# readLib()
#把common library的smali文件夹删掉
# deletePackageSmali("origin")
##map<string,map<string,int>>来加快扫描速度
scanSmali("origin/malware",malware_apks)
scanSmali("origin/benign",benign_apks)
getTwoData()
writeTwo()
getPass()


# print(malware_apks)
# print(benign_apks)
# print(two)


