import os
import glob
apis=[]
all_apis="all_apis.txt"
benign_dir="origin/benign"
malware_dir="origin/malware"

#获得一个smali的api
def getApis(file):
	global m
	f=open(file)
	lines=f.readlines()
	f.close()
	for i in range(0,len(lines),2):
		apis.append(lines[i][:-1])

def getTSdata():
	global apis
	for api in apis:
		getApiData(api)


#对每个api得到两组数据
def getApiData(api):
	global benign_dir
	global malware_dir
	malware=[]
	benign=[]
	for malware_family in os.listdir(malware_dir):
		if os.path.isdir(os.path.join(malware_dir,malware_family)):
			for apk in os.listdir(os.path.join(malware_dir,malware_family)):
				if os.path.isdir(os.path.join(malware_dir,malware_family,apk)):
					malware.append(getInvokeNum(api,os.path.join(malware_dir,malware_family,apk)))
	for apk in os.listdir(benign_dir):
		# print(os.path.join(benign_dir,apk))
		benign.append(getInvokeNum(api,os.path.join(benign_dir,apk)))
	f=open("two_sample.txt","a+")
	f.write(api+"\n")
	for i in malware:
		f.write(str(i)+" ")
	f.write("\n")
	for i in benign:
		f.write(str(i)+" ")
	f.write("\n")
	f.close()
	

#输入反编译文件的路径输出api调用的次数
def getInvokeNum(api,path):
	count=0
	for p,d,f in os.walk(path):
		for file in f:
			if file[-5:]=="smali":
				f=open(os.path.join(p,file))
				lines=f.readlines()
				f.close()
				for line in lines:
					s=line.split(",")[-1][:-1]
					if s==api:
						count+=1
	return count




getApis(all_apis)
getTSdata()


