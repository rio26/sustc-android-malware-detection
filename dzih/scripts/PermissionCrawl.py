#!/usr/bin/python3
from androguard.core.bytecodes.apk import APK
import os
import json

# def get_permissions(apkPath,apkName):
# 	a = APK(apkPath)
# 	jsonFile=apkName+"_perm.json"
# 	f = open(jsonFile,'w')
# 	print(a.get_permissions(),file=f)
# 	f.close()
def get_hardware(apk):
	features=apk.get_features()
	hwc=[]
	for fea in features:
		if ('hardware' in fea):
			hwc.append(fea)
	return hwc

def get_data(tmpFamilyPath,varietyPath,apkPath,apkName,manifestPath):
	try:
		a = APK(apkPath)
	except Exception as e:
		fail=open('fail.txt','a')
		print(apkName,file=fail)
		print(e,file=fail)
		# get_permissions(apkPath,apkName)
		fail.close()
	jsonFile=manifestPath+"/"+apkName+".json"
	pro=a.get_providers()
	rec=a.get_receivers()
	ser=a.get_services()
	act=a.get_activities()
	per=a.get_permissions()
	hwc=get_hardware(a)
	data={'permissions':[],'hardwareComponent':[],'components':{}}
	data['permissions']=per
	data['hardwareComponent']=hwc
	data['components']['providers']=pro
	data['components']['receivers']=rec
	data['components']['services']=rec
	data['components']['activities']=act
	with open(jsonFile,'w') as f:
		json.dump(data,f)

def traverse(tmpFamilyPath,path,manifestPath):
	apks = os.listdir(path)
	for apk in apks:
		apkPath=os.path.join(path,apk)
		if (apk[-3:]=='apk'):
			apkName=apk[0:-4]
			try:
				get_data(tmpFamilyPath,path,apkPath,apkName,manifestPath)
			except Exception as e:
				fail=open('fail.txt','a')
				print(apkName,file=fail)
				print(e,file=fail)
				# get_permissions(apkPath,apkName)
				fail.close()

families = os.listdir('/home/dell/AndroidMalwareAnalysis/amd')
for family in families:
      tmpFamilyPath = os.path.join('/home/dell/AndroidMalwareAnalysis/amd',family)
      if (not os.path.isdir(tmpFamilyPath)):
          continue
      varieties=os.listdir(tmpFamilyPath)
      print(family)
      for variety in varieties:
          if (variety[0:7]=='variety'):
              print(variety)
              tmpVarietyPath=os.path.join(tmpFamilyPath,variety)
              manifestPath=os.path.join(tmpFamilyPath,'manifest'+variety[-1])
              if not os.path.exists(manifestPath):
                  os.makedirs(manifestPath)
              traverse(tmpFamilyPath,tmpVarietyPath,manifestPath)
#traverse("/home/dell/AndroidMalwareAnalysis/BenignAPK")

